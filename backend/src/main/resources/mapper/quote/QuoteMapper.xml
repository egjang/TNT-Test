<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tnt.sales.quote.mapper.QuoteMapper">

    <!-- 견적 목록 조회 -->
    <select id="selectQuotes" resultType="map">
        SELECT
            q.id,
            q.quote_id as "quoteId",
            q.quote_name as "quoteName",
            q.company_type as "companyType",
            q.quote_status as "quoteStatus",
            q.record_type as "recordType",
            q.total_amount as "totalAmount",
            q.expected_profit_rate as "expectedProfitRate",
            q.assignee_id as "assigneeId",
            to_char(q.created_at, 'YYYY-MM-DD') as "createdAt",
            p.project_name as "projectName",
            (SELECT string_agg(c.customer_name, ', ')
             FROM quote_customer qc2
             JOIN customer c ON qc2.account_id = c.customer_id
             WHERE qc2.quote_id = q.quote_id
             LIMIT 3) as "accountNames"
        FROM quote q
        LEFT JOIN project p ON q.project_id = p.project_id
        <where>
            <if test="keyword != null and keyword != ''">
                AND (q.quote_name LIKE concat('%', #{keyword}, '%') OR q.quote_id LIKE concat('%', #{keyword}, '%'))
            </if>
            <if test="customer != null and customer != ''">
                AND EXISTS (
                    SELECT 1 FROM quote_customer qc
                    JOIN customer c ON qc.account_id = c.customer_id
                    WHERE qc.quote_id = q.quote_id AND c.customer_name LIKE concat('%', #{customer}, '%')
                )
            </if>
            <if test="status != null and status != ''">
                AND q.quote_status = #{status}
            </if>
            <if test="startDate != null and startDate != ''">
                AND q.created_at >= to_timestamp(#{startDate}, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null and endDate != ''">
                AND q.created_at &lt; to_timestamp(#{endDate}, 'YYYY-MM-DD') + interval '1 day'
            </if>
        </where>
        ORDER BY q.created_at DESC
    </select>

    <!-- 견적 상세 조회 -->
    <select id="selectQuoteById" resultType="map">
        SELECT
            q.id,
            q.quote_id as "quoteId",
            q.quote_name as "quoteName",
            q.company_type as "companyType",
            q.quote_status as "quoteStatus",
            q.record_type as "recordType",
            q.approval_rule as "approvalRule",
            q.total_amount as "totalAmount",
            q.total_cost as "totalCost",
            q.expected_profit_rate as "expectedProfitRate",
            q.erp_sync_yn as "erpSyncYn",
            q.assignee_id as "assigneeId",
            q.project_id as "projectId",
            p.project_name as "projectName",
            to_char(q.created_at, 'YYYY-MM-DD HH24:MI') as "createdAt",
            to_char(q.updated_at, 'YYYY-MM-DD HH24:MI') as "updatedAt",
            q.created_by as "createdBy",
            q.updated_by as "updatedBy"
        FROM quote q
        LEFT JOIN project p ON q.project_id = p.project_id
        WHERE q.id = #{id}::bigint
    </select>

    <!-- 견적별 거래처 목록 조회 -->
    <select id="selectQuoteCustomers" resultType="map">
        SELECT
            qc.id,
            qc.quote_id as "quoteId",
            qc.account_id as "accountId",
            c.customer_name as "accountName",
            qc.subtotal_amount as "subtotalAmount",
            qc.subtotal_cost as "subtotalCost",
            qc.subtotal_profit_rate as "subtotalProfitRate",
            qc.remark
        FROM quote_customer qc
        JOIN customer c ON qc.account_id = c.customer_id
        WHERE qc.quote_id = #{quoteId}
        ORDER BY qc.id
    </select>

    <!-- 견적 거래처별 품목 목록 조회 -->
    <select id="selectQuoteItems" resultType="map">
        SELECT
            qi.id,
            qi.item_id as "itemId",
            qi.quote_customer_id as "quoteCustomerId",
            qi.item_no as "itemNo",
            i.item_name as "itemName",
            qi.quantity,
            qi.unit_price as "unitPrice",
            qi.ref_tier as "refTier",
            qi.ref_cost as "refCost",
            qi.ref_individual_avg as "refIndividualAvg",
            qi.row_profit_rate as "rowProfitRate",
            qi.remark,
            (qi.quantity * qi.unit_price) as "amount"
        FROM quote_item qi
        JOIN item i ON qi.item_no = i.item_no AND i.company_type = 'TNT'
        WHERE qi.quote_customer_id = #{quoteCustomerId}
        ORDER BY qi.id
    </select>

    <!-- 견적 신규 등록 -->
    <insert id="insertQuote" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO quote (
            quote_id,
            quote_name,
            company_type,
            project_id,
            assignee_id,
            record_type,
            quote_status,
            approval_rule,
            total_amount,
            total_cost,
            expected_profit_rate,
            created_by,
            updated_by
        ) VALUES (
            #{quoteId},
            #{quoteName},
            #{companyType},
            #{projectId},
            #{assigneeId},
            #{recordType},
            'DRAFT',
            #{approvalRule},
            #{totalAmount},
            #{totalCost},
            #{expectedProfitRate},
            #{assigneeId},
            #{assigneeId}
        )
    </insert>

    <!-- 견적 거래처 등록 -->
    <insert id="insertQuoteCustomer" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO quote_customer (
            quote_id,
            account_id,
            subtotal_amount,
            subtotal_cost,
            subtotal_profit_rate,
            remark,
            created_by,
            updated_by
        ) VALUES (
            #{quoteId},
            #{accountId},
            #{subtotalAmount},
            #{subtotalCost},
            #{subtotalProfitRate},
            #{remark},
            #{createdBy},
            #{createdBy}
        )
    </insert>

    <!-- 견적 품목 등록 -->
    <insert id="insertQuoteItem">
        INSERT INTO quote_item (
            item_id,
            quote_customer_id,
            item_no,
            quantity,
            unit_price,
            ref_tier,
            ref_cost,
            ref_individual_avg,
            row_profit_rate,
            remark,
            created_by,
            updated_by
        ) VALUES (
            #{itemId},
            #{quoteCustomerId},
            #{itemNo},
            #{quantity},
            #{unitPrice},
            #{refTier},
            #{refCost},
            #{refIndividualAvg},
            #{rowProfitRate},
            #{remark},
            #{createdBy},
            #{createdBy}
        )
    </insert>

    <!-- 견적 수정 -->
    <update id="updateQuote">
        UPDATE quote
        SET
            quote_name = #{quoteName},
            project_id = #{projectId},
            record_type = #{recordType},
            approval_rule = #{approvalRule},
            total_amount = #{totalAmount},
            total_cost = #{totalCost},
            expected_profit_rate = #{expectedProfitRate},
            updated_at = now(),
            updated_by = #{assigneeId}
        WHERE id = #{id}::bigint
    </update>

    <!-- 견적 상태 변경 -->
    <update id="updateQuoteStatus">
        UPDATE quote
        SET
            quote_status = #{status},
            approval_rule = #{approvalRule},
            updated_at = now()
        WHERE id = #{id}::bigint
    </update>

    <!-- 견적 품목 삭제 (견적 ID 기준) -->
    <delete id="deleteQuoteItems">
        DELETE FROM quote_item
        WHERE quote_customer_id IN (
            SELECT id FROM quote_customer WHERE quote_id = (SELECT quote_id FROM quote WHERE id = #{id}::bigint)
        )
    </delete>

    <!-- 견적 거래처 삭제 (견적 ID 기준) -->
    <delete id="deleteQuoteCustomers">
        DELETE FROM quote_customer
        WHERE quote_id = (SELECT quote_id FROM quote WHERE id = #{id}::bigint)
    </delete>

    <!-- 고객 목록 조회 (콤보박스용) -->
    <select id="selectCustomers" resultType="map">
        SELECT
            customer_id as "customerId",
            customer_name as "customerName",
            addr_province_name as "region"
        FROM customer
        WHERE company_type = #{companyType}
        <if test="keyword != null and keyword != ''">
            AND (customer_name LIKE concat('%', #{keyword}, '%') OR customer_id LIKE concat('%', #{keyword}, '%'))
        </if>
        ORDER BY customer_name
        LIMIT 50
    </select>

    <!-- 품목 목록 조회 (콤보박스용) -->
    <select id="selectItems" resultType="map">
        SELECT
            item_no as "itemNo",
            item_name as "itemName",
            item_category as "category",
            item_unit as "unit",
            unit_price as "listPrice"
        FROM item
        WHERE company_type = #{companyType}
        <if test="keyword != null and keyword != ''">
            AND (item_name LIKE concat('%', #{keyword}, '%') OR item_no LIKE concat('%', #{keyword}, '%'))
        </if>
        ORDER BY item_name
        LIMIT 50
    </select>

    <!-- 프로젝트 목록 조회 (콤보박스용) -->
    <select id="selectProjects" resultType="map">
        SELECT
            project_id as "projectId",
            project_name as "projectName"
        FROM project
        WHERE company_type = #{companyType}
        AND (status_cd IS NULL OR status_cd = 'ACTIVE')
        <if test="keyword != null and keyword != ''">
            AND (project_name LIKE concat('%', #{keyword}, '%') OR project_id LIKE concat('%', #{keyword}, '%'))
        </if>
        ORDER BY project_name
        LIMIT 50
    </select>

    <!-- 견적번호 생성을 위한 당일 최대 시퀀스 조회 -->
    <select id="selectMaxQuoteSeq" resultType="int">
        SELECT COALESCE(MAX(CAST(SUBSTRING(quote_id, 9) AS INTEGER)), 0)
        FROM quote
        WHERE quote_id LIKE concat(#{datePrefix}, '%')
    </select>

</mapper>
