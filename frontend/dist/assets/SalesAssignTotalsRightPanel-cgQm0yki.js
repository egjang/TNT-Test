import{r as o,j as t}from"./index-BDCdW1US.js";function J(){const[r,$]=o.useState(()=>{const e=typeof window<"u"?localStorage.getItem("tnt.sales.assign.year"):null,a=e?Number(e):NaN;return Number.isFinite(a)?a:new Date().getFullYear()}),[j,b]=o.useState([]),[g,M]=o.useState(()=>{try{const e=localStorage.getItem("tnt.sales.assign.empList"),a=e?JSON.parse(e):[];return Array.isArray(a)?a.map(m=>({key:String(m.key??m.empId??(m.empName?`name:${m.empName}`:"")),empId:String(m.empId??""),empName:String(m.empName??""),deptName:String(m.deptName??"")})):[]}catch{return[]}}),[L,x]=o.useState(!1),[A,w]=o.useState(null),u=new Intl.NumberFormat("ko-KR"),[d,E]=o.useState("cur");o.useEffect(()=>{const e=()=>{try{const m=localStorage.getItem("tnt.sales.assign.year"),c=m?Number(m):NaN;Number.isFinite(c)&&$(c)}catch{}},a=()=>{try{const m=localStorage.getItem("tnt.sales.assign.empList"),c=m?JSON.parse(m):[];Array.isArray(c)&&M(c.map(p=>({key:String(p.key??p.empId??(p.empName?`name:${p.empName}`:"")),empId:String(p.empId??""),empName:String(p.empName??""),deptName:String(p.deptName??"")})))}catch{}};return window.addEventListener("tnt.sales.assign.year.changed",e),window.addEventListener("tnt.sales.assign.emps.changed",a),()=>{window.removeEventListener("tnt.sales.assign.year.changed",e),window.removeEventListener("tnt.sales.assign.emps.changed",a)}},[]);async function _(){x(!0),w(null);try{const e=Number.isFinite(r)?r:new Date().getFullYear(),a=d==="cur"?[e-1]:d==="prev"?[e-2]:d==="cur_prev"?[e-1,e-2]:[e-1,e-2,e-3],m=(g||[]).map(s=>String(s.empName||"").trim()).filter(s=>!!s),c=m.length>0,p=new Map,S=new Map,v=new Map,y=new URL("/api/v1/sales/employee-yearly",window.location.origin);y.searchParams.set("year",String(r)),y.searchParams.set("exact","true"),y.searchParams.set("years",a.join(",")),c&&(y.searchParams.set("empNames",m.join(",")),y.searchParams.set("joinKey","emp_name"));const I=await fetch(y.toString()),i=I.ok?await I.json():[],T=Array.isArray(i)?i:Array.isArray(i==null?void 0:i.employees)?i.employees:[];Array.isArray(T)&&T.forEach(s=>{const l=String(s.emp_name??s.empName??"").trim(),n=Number(s.amount??0),N=Number(s.tnt_amount??0),P=Number(s.dys_amount??0);if(c){const f=S.get(l)||{amount:0,tntAmount:0,dysAmount:0,anyRow:s},D={amount:(f.amount||0)+n,tntAmount:(f.tntAmount||0)+N,dysAmount:(f.dysAmount||0)+P,anyRow:f.anyRow||s};S.set(l,D)}}),(Array.isArray(i==null?void 0:i.companyTotals)?i.companyTotals:[]).forEach(s=>{const l=String(s.company_type||s.companyType||"").toUpperCase(),n=Number(s.amount||0);v.set(l,(v.get(l)||0)+(Number.isFinite(n)?n:0))});const R=(g&&g.length?g:[]).map(s=>{if(c){const l=String(s.empName||"").trim(),n=S.get(l),N=(n==null?void 0:n.anyRow)||{};return{key:String(s.key||s.empId||(s.empName?`name:${s.empName}`:"")),empId:String(s.empId||N.emp_id||""),empName:String(s.empName||N.emp_name||l),deptName:String(s.deptName||N.dept_name||""),amount:Number((n==null?void 0:n.amount)||0),tntAmount:Number((n==null?void 0:n.tntAmount)||0),dysAmount:Number((n==null?void 0:n.dysAmount)||0)}}});b(R);const Y=Array.from(v.entries()).map(([s,l])=>({company_type:s,amount:l}));k(Y)}catch(e){w((e==null?void 0:e.message)||"조회 오류"),b([])}finally{x(!1)}}o.useEffect(()=>{_()},[r,g,d]);const[h,k]=o.useState([]),z=j.reduce((e,a)=>e+(Number(a.amount)||0),0),C=o.useMemo(()=>{var e;return((e=h.find(a=>String(a.company_type||"").toUpperCase()==="TNT"))==null?void 0:e.amount)||0},[h]),F=o.useMemo(()=>{var e;return((e=h.find(a=>String(a.company_type||"").toUpperCase()==="DYS"))==null?void 0:e.amount)||0},[h]);return t.jsxs("div",{style:{padding:8,fontSize:12},children:[A&&t.jsx("div",{className:"error",children:A}),L?t.jsx("div",{className:"empty-state",children:"불러오는 중…"}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"card",style:{padding:8,marginBottom:6},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6},children:[(()=>{const e=d==="cur"?`${r-1}년 매출 합계`:d==="prev"?`${r-2}년 매출 합계`:d==="cur_prev"?`${r-1}년~${r-2}년 매출 합계`:`${r-1}년~${r-3}년 매출 합계`;return t.jsx("div",{style:{fontWeight:700},children:e})})(),t.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:6},children:[t.jsx("span",{className:"muted",children:"매출구간"}),t.jsxs("select",{className:"search-input",value:d,onChange:e=>E(e.target.value),"aria-label":"집계 기간 선택",style:{height:26},children:[t.jsx("option",{value:"cur",children:`${r-1}년`}),t.jsx("option",{value:"prev",children:`${r-2}년`}),t.jsx("option",{value:"cur_prev",children:`${r-1}년~${r-2}년`}),t.jsx("option",{value:"last3",children:`${r-1}년~${r-3}년`})]})]})]}),t.jsxs("div",{style:{display:"flex",alignItems:"baseline",gap:8},children:[t.jsxs("div",{style:{fontSize:18,fontWeight:800},children:[u.format(Math.round(z))," 원"]}),t.jsxs("div",{className:"badge",style:{fontSize:11,padding:"2px 6px"},children:["TNT: ",u.format(Math.round(C))," 원"]}),t.jsxs("div",{className:"badge",style:{fontSize:11,padding:"2px 6px"},children:["DYS: ",u.format(Math.round(F))," 원"]})]})]}),t.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:2},children:j.map((e,a)=>t.jsxs("div",{className:"card",style:{padding:6},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx("div",{style:{fontWeight:700},children:e.empName}),t.jsxs("div",{className:"muted",style:{fontSize:11},children:["(",e.empId,")"]}),t.jsx("div",{className:"muted",style:{marginLeft:"auto",fontSize:11},children:e.deptName})]}),t.jsxs("div",{style:{display:"flex",alignItems:"baseline",gap:8,marginTop:4},children:[t.jsxs("div",{style:{fontSize:14,fontWeight:700},children:[u.format(Math.round(e.amount))," 원"]}),t.jsxs("div",{className:"badge",style:{fontSize:11,padding:"2px 6px"},children:["TNT: ",u.format(Math.round(Number(e.tntAmount||0)))," 원"]}),t.jsxs("div",{className:"badge",style:{fontSize:11,padding:"2px 6px"},children:["DYS: ",u.format(Math.round(Number(e.dysAmount||0)))," 원"]})]})]},`${e.key||e.empId||e.empName}-${a}`))})]})]})}export{J as SalesAssignTotalsRightPanel};
