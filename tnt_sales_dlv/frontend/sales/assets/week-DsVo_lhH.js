import{j as t,r as n,R as T}from"./index-C5CiSje-.js";function $t({value:h,onChange:g,placeholder:u,readOnly:v,className:b,style:$}){return t.jsx("input",{type:"text",className:["subject-input",b].filter(Boolean).join(" "),style:$,value:h,onChange:k=>g==null?void 0:g(k.target.value),placeholder:u,readOnly:v})}const Xt=[{value:"정기방문",label:"정기방문"},{value:"영업기회",label:"영업기회"},{value:"채권관리",label:"채권관리"}],Zt=[{value:"계획",label:"계획"},{value:"완료",label:"완료"},{value:"취소",label:"취소"},{value:"연기",label:"연기"},{value:"미방문",label:"미방문"}],Mt=[{value:"방문",label:"방문"},{value:"전화",label:"전화"},{value:"문자/메일/팩스",label:"문자/메일/팩스"},{value:"기타",label:"기타"}],te=["공개","팀공유","개인"];function de({bare:h=!1,initial:g,editId:u,leadId:v,onSaved:b,onNoticeClose:$,lockSubject:k,planMode:s,multiTargets:E}){const[l,ut]=n.useState(null),[dt,ae]=n.useState(""),[R,Z]=n.useState(""),[F,M]=n.useState(""),[z,Lt]=n.useState(!1),[W,Bt]=n.useState(!1),[J,pt]=n.useState("공개"),[V,tt]=n.useState("방문"),[L,mt]=n.useState("정기방문"),[A,ft]=n.useState("계획"),[gt,Ut]=n.useState(""),[se,Yt]=n.useState(""),[ne,Ht]=n.useState(!1),[yt,ie]=n.useState(""),Ft=!1,[D,K]=n.useState(""),[O,B]=n.useState(""),[et,ht]=n.useState(""),[U,vt]=n.useState(""),[y,St]=n.useState(null),[at,xt]=n.useState(g??null),[jt,ce]=n.useState(""),[wt,re]=n.useState(""),[C,bt]=n.useState(""),[zt,st]=n.useState([]),[At,nt]=n.useState(!1),[le,Wt]=n.useState(null),[Nt,Y]=n.useState(null),[It,q]=n.useState(()=>({open:!1,text:""})),[Tt,it]=n.useState(null),[Dt,Jt]=n.useState(new Date),ct=T.useRef(null),H=at??g,G=(H==null?void 0:H.id)??u??(s?"plan":"new"),x=n.useMemo(()=>localStorage.getItem("tnt.sales.empId"),[]),P=n.useMemo(()=>localStorage.getItem("tnt.sales.assigneeId"),[]);n.useMemo(()=>{try{const e=localStorage.getItem("tnt.sales.selectedCustomer");e&&ut(JSON.parse(e))}catch{ut(null)}},[]);const Q=T.useCallback(async()=>{try{const e=[],c=!!(P||x);P?e.push(["assigneeId",String(P)]):x&&e.push(["empId",String(x)]);async function a(i){const d=new URL("/api/v1/sales-activities",window.location.origin);i&&d.searchParams.set("sfAccountId",i),e.forEach(([j,_])=>d.searchParams.set(j,_)),d.searchParams.set("mineOnly",c?"true":"false"),d.searchParams.set("onlyRoot","true"),d.searchParams.set("limit","200");const f=await fetch(d.toString());if(!f.ok)return[];const I=await f.json();return Array.isArray(I)?I:[]}if(v){const i=new URL("/api/v1/sales-activities",window.location.origin);i.searchParams.set("sfLeadId",String(v)),e.forEach(([j,_])=>i.searchParams.set(j,_)),i.searchParams.set("mineOnly",c?"true":"false"),i.searchParams.set("onlyRoot","true"),i.searchParams.set("limit","200");const d=await fetch(i.toString()),f=d.ok?await d.json():[],I=Array.isArray(f)?f:[];st(I.slice(0,200));return}const o=[];y!=null&&y.id&&o.push(String(y.id)),l!=null&&l.customerId&&o.push(String(l.customerId)),(l==null?void 0:l.customerSeq)!=null&&o.push(String(l.customerSeq)),U&&o.push(String(U));const p=Array.from(new Set(o.filter(Boolean)));let m=[];p.length>0?m=(await Promise.all(p.map(d=>a(d)))).flat():m=await a(void 0);const N=new Map;m.forEach(i=>{i&&i.id!=null&&N.set(Number(i.id),i)});let r=Array.from(N.values());const w=g||{},S=w.parentActivitySeq!=null?Number(w.parentActivitySeq):void 0;S&&!r.some(i=>Number(i.id)===S)&&(r=[{id:S,subject:w.parentSubject||"상위활동"},...r]),r.sort((i,d)=>{const f=i.createdAt?new Date(i.createdAt).getTime():0;return(d.createdAt?new Date(d.createdAt).getTime():0)-f}),st(r.slice(0,200))}catch{st([])}},[y==null?void 0:y.id,l==null?void 0:l.customerSeq,l==null?void 0:l.customerId,U,x,P,g==null?void 0:g.parentActivitySeq,g==null?void 0:g.parentSubject,v]);T.useEffect(()=>{Q()},[Q]),T.useEffect(()=>{if(!u){xt(g??null);return}let e=!1;return(async()=>{try{const c=await fetch(`/api/v1/sales-activities/${u}`);if(!c.ok)throw new Error(`HTTP ${c.status}`);const a=await c.json();if(e)return;const o={id:a.id,subject:a.subject,description:a.description,channel:a.channel,activityType:a.activityType,activityStatus:a.activityStatus,plannedStartAt:a.plannedStartAt||a.planned_start_at,actualStartAt:a.actualStartAt||a.actual_start_at,sfAccountId:a.sfAccountId??a.sf_account_id,customerName:a.customerName??a.customer_name,parentActivitySeq:a.parentSeq??a.parent_activity_seq,parentSubject:a.parentSubject??a.parent_subject};xt(o)}catch(c){console.error("Failed to load activity detail for edit:",c)}})(),()=>{e=!0}},[u,g]),T.useEffect(()=>{if(!(ct.current!==G||u&&at)&&ct.current===G)return;ct.current=G;const c=w=>{if(!w)return"";const S=new Date(w);if(isNaN(S.getTime()))return"";const i=S.getTimezoneOffset();return new Date(S.getTime()-i*6e4).toISOString().slice(0,16)},a=H||{};Z(a.subject??""),M(a.description??"");const o={in_person:"방문",phone:"전화",email:"문자/메일/팩스",other:"기타"},p={site_visit:"정기방문",opportunity:"영업기회",AR_mgmt:"채권관리",meeting:"미팅",call:"전화",email:"이메일",demo:"데모",task:"업무",other:"기타"},m={scheduled:"계획",completed:"완료",canceled:"취소",postponed:"연기",no_show:"미방문"},N={public:"공개",team:"팀공유",private:"개인"};tt(a.channel&&(o[a.channel]||a.channel)||"방문"),mt(a.activityType&&(p[a.activityType]||a.activityType)||"정기방문"),ft(s?"계획":a.activityStatus&&(m[a.activityStatus]||a.activityStatus)||"계획"),pt(a.visibility?N[a.visibility]||String(a.visibility):"공개"),K(c(a.plannedStartAt));const r=c(a.actualStartAt);B(r),ht(r),vt(a.sfAccountId!=null?String(a.sfAccountId):""),bt(a.parentActivitySeq!=null?String(a.parentActivitySeq):""),a.sfAccountId&&String(a.sfAccountId)||a.customerName?St({id:a.sfAccountId?String(a.sfAccountId):void 0,name:a.customerName?String(a.customerName):void 0}):St(null)},[H,G,s,u,at]),T.useEffect(()=>{u||s||K(e=>{if(e&&String(e).trim()!=="")return e;const c=new Date,a=c.getTimezoneOffset();return new Date(c.getTime()-a*6e4).toISOString().slice(0,16)})},[u,s]);const[Ot,Ct]=T.useState(""),[Pt,Vt]=T.useState(!0);T.useEffect(()=>{if(Pt){Ct(A),Vt(!1);return}if(!(Ot===A||s)){if(A==="완료"&&(!et||String(et).trim()==="")){const e=new Date,c=e.getTimezoneOffset(),o=new Date(e.getTime()-c*6e4).toISOString().slice(0,16);B(o)}Ct(A)}},[A,et,s,Ot,Pt]),T.useEffect(()=>{!O||D||K(O)},[O,D]);const[Kt,X]=n.useState(!1);T.useEffect(()=>{let e=!1;async function c(){try{if(!u){e||X(!1);return}const a=new URL("/api/v1/sales-activities",window.location.origin);a.searchParams.set("parentSeq",String(u)),a.searchParams.set("mineOnly","false"),a.searchParams.set("limit","1");const o=await fetch(a.toString());if(!o.ok){e||X(!1);return}const p=await o.json(),m=Array.isArray(p)?p:[];e||X(m.length>0)}catch{e||X(!1)}}return c(),()=>{e=!0}},[u]);const rt=!!(u&&Kt);async function Gt(){if(Y(null),it(null),Wt(null),!x){Y("로그인이 필요합니다");return}let e=O;if(["완료","취소","미방문"].includes(A)&&(!O||O.trim()==="")){const a=new Date,o=a.getTimezoneOffset();e=new Date(a.getTime()-o*6e4).toISOString().slice(0,16),B(e)}if(e&&!["완료","취소","미방문"].includes(A)){q({open:!0,text:"종료일시가 입력된 경우 상태는 완료, 취소, 미방문 중 하나여야 합니다."});return}const c=dt&&dt.trim()||P||x||"";if(!c||!L||!A){Y("필수 항목: 활동유형, 상태 (로그인 필요)");return}nt(!0);try{const a=m=>m?new Date(m).toISOString():void 0;let o=!1,p;if(u){const m=a(D),N=e?e.trim():"",r=a(N),w=N?r:"",S={subject:R||void 0,description:F||void 0,activityStatus:A||void 0,activityType:L||void 0,channel:V||void 0,isAllDay:z,isPrivate:W,visibility:J,parentActivitySeq:rt?void 0:C?Number(C):void 0,plannedStartAt:m,actualStartAt:w},i=D?new Date(D).getTime():m?new Date(m).getTime():NaN,d=N?new Date(N).getTime():r?new Date(r).getTime():NaN;if(!isNaN(i)&&!isNaN(d)&&d<i){const j="종료일시는 계획 일시보다 커야 합니다.";nt(!1),Y(j),it(j);return}const f=await fetch(`/api/v1/sales-activities/${u}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(S)}),I=await f.json().catch(()=>({}));if(!f.ok||I.error)throw new Error(I.error||`HTTP ${f.status}`);o=!0,p=u;try{const j=new URL("/api/v1/sales-activities",window.location.origin);P&&j.searchParams.set("assigneeId",P),x&&j.searchParams.set("empId",x),j.searchParams.set("mineOnly","true"),j.searchParams.set("_t",Date.now().toString());const _=await fetch(j.toString(),{cache:"no-cache"});if(_.ok){const kt=await _.json(),lt=Array.isArray(kt)?kt.find(Et=>Et.id===u):null;if(lt){const qt=(_t=>{if(!_t)return"";const ot=new Date(_t);if(isNaN(ot.getTime()))return"";const Qt=ot.getTimezoneOffset();return new Date(ot.getTime()-Qt*6e4).toISOString().slice(0,16)})(lt.actualStartAt||lt.actual_start_at);B(qt),ht(qt)}}}catch(j){console.error("Failed to reload activity data:",j)}q({open:!0,text:"수정되었습니다."});try{window.dispatchEvent(new CustomEvent("tnt.sales.activity.updated",{detail:{id:p}}))}catch{}try{b&&b(p)}catch{}}else{const m=new Date().toISOString(),N=s&&Array.isArray(E)&&E.length>0?E:null;if(N){for(const r of N){const w=((r==null?void 0:r.customerName)||"").trim(),S=w?`${w} (활동계획)`:R||void 0,i=r!=null&&r.customerId?String(r.customerId):(r==null?void 0:r.customerSeq)!=null?String(r.customerSeq):void 0;if(!i)continue;const d={sfOwnerId:c,subject:S,description:F||void 0,isAllDay:z,isPrivate:W,visibility:J,channel:V,activityType:L,activityStatus:A,nextStep:gt||void 0,nextStepDueAt:a(yt),plannedStartAt:a(D),actualStartAt:a(e)||m,parentActivitySeq:C?Number(C):void 0,sfLeadId:v?String(v):void 0,sfAccountId:v?void 0:i,sfContactId:jt||void 0,sfOpportunityId:wt||void 0,createdBy:x,updatedBy:x,createdAt:m,updatedAt:m},f=await fetch("/api/v1/sales-activities",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)}),I=await f.json().catch(()=>({}));if(!f.ok||I.error)throw new Error(I.error||`HTTP ${f.status}`);p=I.id;try{window.dispatchEvent(new CustomEvent("tnt.sales.activity.updated",{detail:{id:p}}))}catch{}}o=!0,q({open:!0,text:"저장되었습니다."});try{b&&b(p)}catch{}}else{const r=((y==null?void 0:y.name)||(l==null?void 0:l.customerName)||"").trim(),w=s&&r?`${r} (활동계획)`:R||void 0,S=new Date().toISOString(),i={sfOwnerId:c,subject:w,description:F||void 0,isAllDay:z,isPrivate:W,visibility:J,channel:V,activityType:L,activityStatus:A,nextStep:gt||void 0,nextStepDueAt:a(yt),plannedStartAt:a(D),actualStartAt:a(e)||S,parentActivitySeq:C?Number(C):void 0,sfLeadId:v?String(v):void 0,sfAccountId:v?void 0:((y==null?void 0:y.id)??(l!=null&&l.customerId?String(l.customerId):U))||void 0,sfContactId:jt||void 0,sfOpportunityId:wt||void 0,createdBy:x,updatedBy:x,createdAt:S,updatedAt:S},d=await fetch("/api/v1/sales-activities",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),f=await d.json().catch(()=>({}));if(!d.ok||f.error)throw new Error(f.error||`HTTP ${d.status}`);o=!0,p=f.id,q({open:!0,text:"저장되었습니다."});try{window.dispatchEvent(new CustomEvent("tnt.sales.activity.updated",{detail:{id:p}}))}catch{}try{b&&b(p)}catch{}}}Jt(new Date),u||(Z(""),M(""),Ut(""),Yt(""),Ht(!1))}catch(a){q({open:!0,text:a.message||"저장 중 오류가 발생했습니다"})}finally{nt(!1)}}return t.jsxs("section",{children:[!h&&t.jsxs("div",{className:"page-title",children:[t.jsx("h2",{children:"영업활동 등록"}),t.jsxs("div",{className:"meta",children:[t.jsx("span",{className:"badge",children:"Draft"}),t.jsxs("span",{className:"badge",children:["Last Saved: ",t.jsx("time",{children:Dt?Dt.toLocaleString():"—"})]})]})]}),!x&&t.jsx("div",{className:"error",style:{marginBottom:8},children:"로그인이 필요합니다"}),t.jsxs("section",{className:h?void 0:s?"card plan-compact-card":"card",children:[t.jsxs("div",{className:s?"plan-compact":"form-grid",style:s?{display:"flex",flexDirection:"column",gap:6}:void 0,children:[t.jsxs("div",{className:"field row-2",style:{display:"grid",gridTemplateColumns:s?"90px 260px":"120px 1fr",gap:s?6:8,alignItems:"center"},children:[t.jsx("label",{children:"제목"}),t.jsx($t,{value:R,onChange:k?void 0:Z,placeholder:"예: 고객사 주간 미팅",readOnly:!!k})]}),!s&&t.jsxs("div",{className:"field row-2",style:{display:"grid",gridTemplateColumns:"120px 1fr",gap:8,alignItems:"center"},children:[t.jsx("label",{children:"활동 설명"}),t.jsx("textarea",{value:F,onChange:e=>M(e.target.value),rows:4})]}),t.jsxs("div",{className:"field",style:{display:"grid",gridTemplateColumns:s?"90px 260px":"120px 1fr",gap:s?6:8,alignItems:"center"},children:[t.jsx("label",{children:"활동유형 *"}),t.jsx("select",{value:L,onChange:e=>{const c=e.target.value;mt(c);const a={정기방문:"방문",영업기회:"방문",채권관리:"전화"};a[c]&&tt(a[c])},children:Xt.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),t.jsxs("div",{className:"field",style:{display:"grid",gridTemplateColumns:s?"90px 260px":"120px 1fr",gap:s?6:8,alignItems:"center"},children:[t.jsx("label",{children:"활동방법"}),t.jsx("select",{value:V,onChange:e=>tt(e.target.value),children:Mt.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),t.jsxs("div",{className:"field",style:{display:"grid",gridTemplateColumns:s?"90px 260px":"120px 1fr",gap:s?6:8,alignItems:"center"},children:[t.jsx("label",{children:"상태 *"}),t.jsx("select",{value:A,onChange:e=>ft(e.target.value),disabled:!!s,children:Zt.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),!s&&t.jsxs("div",{className:"field",style:{display:"grid",gridTemplateColumns:"120px 1fr",gap:8,alignItems:"center"},children:[t.jsx("label",{children:"상위 활동"}),t.jsxs("select",{value:C,onChange:e=>bt(e.target.value),onFocus:()=>{try{Q()}catch{}},onClick:()=>{try{Q()}catch{}},disabled:rt,title:rt?"하위활동이 존재하여 상위활동을 변경할 수 없습니다":void 0,children:[t.jsx("option",{value:"",children:"선택"}),zt.map(e=>{const c={site_visit:"정기방문",opportunity:"영업기회",AR_mgmt:"채권관리",meeting:"미팅",call:"전화",email:"이메일",demo:"데모",task:"업무",other:"기타"},a={scheduled:"계획",completed:"완료",canceled:"취소",postponed:"연기",no_show:"미방문"},o=e.activityType?c[e.activityType]||e.activityType:"",p=e.activityStatus?a[e.activityStatus]||e.activityStatus:"",m=`${e.subject||""}${o||p?` · ${o}${o&&p?" / ":""}${p}`:""}`;return t.jsx("option",{value:e.id,children:m},e.id)})]})]}),t.jsxs("div",{className:"field",style:{display:"grid",gridTemplateColumns:s?"90px 260px":"120px 1fr",gap:s?6:8,alignItems:"center"},children:[t.jsx("label",{children:"계획 일시"}),t.jsxs("div",{className:"datetime-wrapper",children:[t.jsx("input",{type:"datetime-local",className:D?"":"empty",value:D,onChange:e=>K(e.target.value),autoComplete:"off",disabled:!!s,title:s?"달력에서 선택된 일시로 설정됩니다":void 0}),!D&&t.jsx("span",{className:"datetime-placeholder",children:"YYYY-MM-DD HH:MM"})]})]}),!s&&t.jsxs("div",{className:"field",style:{display:"grid",gridTemplateColumns:"120px 1fr",gap:8,alignItems:"center"},children:[t.jsx("label",{children:"종료 일시"}),t.jsxs("div",{className:"datetime-wrapper",children:[t.jsx("input",{type:"datetime-local",className:O?"":"empty",value:O,onChange:e=>B(e.target.value),autoComplete:"off"}),!O&&t.jsx("span",{className:"datetime-placeholder",children:"YYYY-MM-DD HH:MM"})]})]}),Ft,!s&&t.jsxs("div",{className:"field",style:{display:"flex",flexDirection:"row",alignItems:"center",gap:16},children:[t.jsxs("label",{className:"muted",style:{display:"inline-flex",alignItems:"center",gap:8},children:[t.jsx("input",{className:"checkbox-accent",type:"checkbox",checked:z,onChange:e=>Lt(e.target.checked)}),t.jsx("span",{children:"종일"})]}),t.jsxs("label",{className:"muted",style:{display:"inline-flex",alignItems:"center",gap:8},children:[t.jsx("input",{className:"checkbox-accent",type:"checkbox",checked:W,onChange:e=>Bt(e.target.checked)}),t.jsx("span",{children:"비공개"})]})]}),!s&&!v&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"field",style:{display:"grid",gridTemplateColumns:"120px 1fr",gap:8,alignItems:"center"},children:[t.jsx("label",{children:"거래처"}),t.jsx($t,{value:y?y.name||y.id||"":l?l.customerName||String(l.customerId||""):U||"",onChange:y||l?void 0:vt,placeholder:"거래처명 또는 ID",readOnly:!!y||!!l})]}),t.jsxs("div",{className:"field",style:{display:"grid",gridTemplateColumns:"120px 1fr",gap:8,alignItems:"center"},children:[t.jsx("label",{children:"거래처 담당자"}),t.jsx("input",{type:"text",value:"기능 미구현",readOnly:!0,disabled:!0})]}),t.jsxs("div",{className:"field",style:{display:"grid",gridTemplateColumns:"120px 1fr",gap:8,alignItems:"center"},children:[t.jsx("label",{children:"영업기회"}),t.jsx("input",{type:"text",value:"기능 미구현",readOnly:!0,disabled:!0})]})]}),!s&&t.jsxs("div",{className:"field",style:{display:"grid",gridTemplateColumns:"120px 1fr",gap:8,alignItems:"center"},children:[t.jsx("label",{children:"가시성"}),t.jsx("select",{value:J,onChange:e=>pt(e.target.value),children:te.map(e=>t.jsx("option",{value:e,children:e},e))})]})]}),Nt&&t.jsx("div",{className:"error",style:{marginBottom:8},children:Nt}),t.jsx("div",{className:"controls",children:t.jsx("button",{className:"btn",onClick:Gt,disabled:At||!x,children:At?u?"수정 중…":"저장 중…":u?"수정":"저장"})})]}),It.open?t.jsx("div",{role:"dialog","aria-modal":"true",className:"card",style:{position:"fixed",inset:0,background:"rgba(0,0,0,.45)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},children:t.jsxs("div",{className:"card",style:{background:"var(--panel)",padding:12,border:"1px solid var(--border)",borderRadius:10,minWidth:260,maxWidth:"86vw"},children:[t.jsx("div",{style:{marginBottom:8,fontWeight:700,textAlign:"center"},children:It.text}),t.jsx("div",{style:{display:"flex",justifyContent:"center"},children:t.jsx("button",{className:"btn btn-card btn-3d",onClick:()=>{q({open:!1,text:""});try{$&&$()}catch{}},children:"확인"})})]})}):null,Tt?t.jsx("div",{role:"dialog","aria-modal":"true",className:"card",style:{position:"fixed",inset:0,background:"rgba(0,0,0,.3)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},children:t.jsxs("div",{className:"card",style:{background:"var(--panel)",padding:12,border:"1px solid var(--border)",borderRadius:10,minWidth:260,maxWidth:"86vw"},children:[t.jsx("div",{style:{marginBottom:8,fontWeight:700,textAlign:"center",color:"#b91c1c"},children:Tt}),t.jsx("div",{style:{display:"flex",justifyContent:"center"},children:t.jsx("button",{className:"btn btn-card btn-3d",onClick:()=>{it(null),Y(null)},children:"확인"})})]})}):null]})}function ee(h){return new Date(h.getFullYear(),h.getMonth(),h.getDate())}function pe(h=0,g){const b=ee(new Date),k=(b.getDay()-1+7)%7,s=new Date(b);s.setDate(b.getDate()-k+h*7);const E=new Date(s);return E.setDate(s.getDate()+6),{start:s,end:E}}function Rt(h){const g=h.getFullYear(),u=String(h.getMonth()+1).padStart(2,"0"),v=String(h.getDate()).padStart(2,"0");return`${g}-${u}-${v}`}function me(h){return`${Rt(h.start)} ~ ${Rt(h.end)}`}export{$t as S,de as a,me as f,pe as g};
