import{r as h,j as t,f as X,w as Q}from"./index-C5CiSje-.js";import{c as Z}from"./close-CV7tuFPj.js";function le({data:C}){const[l,L]=h.useState(null),[g,N]=h.useState([]),[z,q]=h.useState({}),[O,E]=h.useState(""),[T,D]=h.useState(""),[I,M]=h.useState(()=>{const s=new Date;return s.setMinutes(s.getMinutes()-s.getTimezoneOffset()),s.toISOString().slice(0,10)}),j=(()=>{try{return localStorage.getItem("tnt.sales.empName")||localStorage.getItem("tnt.sales.empId")||""}catch{return""}})(),b=(()=>{try{return localStorage.getItem("tnt.sales.assigneeId")||""}catch{return""}})(),[W,k]=h.useState(!1),[_,w]=h.useState(()=>({open:!1,text:""})),[A,R]=h.useState(null),U=!1,[ee,$]=h.useState(""),[te,H]=h.useState(""),[Y,B]=h.useState("");async function F(s){const o=b||"",n=(()=>{try{return localStorage.getItem("tnt.sales.empId")||""}catch{return""}})();if(!o&&!n)return(()=>{try{return localStorage.getItem("tnt.sales.empSeq")||""}catch{return""}})()||"4";try{const a=new URLSearchParams;o&&a.set("assigneeId",o),n&&a.set("empId",n),s&&a.set("companyCode",s);const e=await fetch(`/api/v1/employee/by-assignee?${a.toString()}`,{cache:"no-store"});if(!e.ok)return(()=>{try{return localStorage.getItem("tnt.sales.empSeq")||""}catch{return""}})()||"4";const i=await e.json().catch(()=>null),r=(i==null?void 0:i.resolvedSalesEmpSeq)??((s==null?void 0:s.toUpperCase())==="DYS"?i==null?void 0:i.dys_emp_seq:i==null?void 0:i.tnt_emp_seq),d=r!=null&&String(r)?String(r):"";return d||(()=>{try{return localStorage.getItem("tnt.sales.empSeq")||""}catch{return""}})()||"4"}catch{return(()=>{try{return localStorage.getItem("tnt.sales.empSeq")||""}catch{return""}})()||"4"}}function V(s){const o=C||{},n=new Date,a=n.getFullYear(),e=String(n.getMonth()+1).padStart(2,"0"),i=String(n.getDate()).padStart(2,"0"),r=`${a}${e}${i}`,d=`A${r}`,u=(g||[]).map(S=>{const K=(Number(S.qty)||0).toFixed(2),G=S.itemStdUnit?` ${S.itemStdUnit}`:"";return`${S.itemName}${S.itemSpec?` ${S.itemSpec}`:""} - ${K}${G}`}).join(`
`),x=String(o.manager||(l==null?void 0:l.ownerName)||""),y=(l==null?void 0:l.companyCode)||o.companyCode||"TNT",m=(s==null?void 0:s.salesEmpSeq)&&String(s.salesEmpSeq)||(()=>{try{const S=localStorage.getItem("tnt.sales.empSeq");return S?String(S):""}catch{return""}})(),c=String(y).toUpperCase(),f=c==="DYS"?"DYS_CRM":"TNT_CRM",J=c==="DYS"?"dys_bis":"tnt_bis";return{payload:{ROOT:{certId:f,certKey:"9836164F-3601-4DBB-9D6D-54685CD89B95",dsn:J,dsnOper:c==="DYS"?"dys_oper":"tnt_oper",dsnBis:J,companySeq:"1",languageSeq:1,securityType:0,userId:j||"",data:{ROOT:{DataBlock1:[{WorkingTag:"A",IDX_NO:0,Status:"0",DataSeq:1,Selected:1,TABLE_NAME:"",UserName:j||"",OrderTextNo:d,StdDate:r,CustSeq:(l==null?void 0:l.customerSeq)!=null?String(l.customerSeq):"",SalesEmpSeq:m,CustEmpName:x,WHSeq:"",DelvDate:(I||"").replaceAll("-",""),OrderText:u,OrderRemark:T||""}]}}}},orderText:u}}h.useEffect(()=>{const s=n=>{var e;const a=((e=n==null?void 0:n.detail)==null?void 0:e.customer)??null;if(L(a),a){const i=a.addrProvinceName??a.addr_province_name??"",r=a.addrCityName??a.addr_city_name??"",d=[i,r].filter(p=>!!p&&String(p).trim().length>0).join(" ");d&&E(String(d));try{B("")}catch{}try{D("")}catch{}try{N([]),q({})}catch{}try{localStorage.setItem("tnt.sales.ordersheet.cart",JSON.stringify([])),window.dispatchEvent(new CustomEvent("tnt.sales.ordersheet.cart.changed",{detail:{cart:[]}}))}catch{}try{localStorage.removeItem("tnt.sales.ordersheet.requests")}catch{}}};window.addEventListener("tnt.sales.ordersheet.customer.selected",s);const o=n=>{var a;N(Array.isArray((a=n==null?void 0:n.detail)==null?void 0:a.cart)?n.detail.cart:[])};return window.addEventListener("tnt.sales.ordersheet.cart.changed",o),()=>{window.removeEventListener("tnt.sales.ordersheet.customer.selected",s),window.removeEventListener("tnt.sales.ordersheet.cart.changed",o)}},[]);const v=C||{};function P(s){try{const n=[JSON.parse(s)];let a=null;for(;n.length;){const e=n.shift();if(Array.isArray(e)){if(e.length&&typeof e[0]=="object"){a=e;break}}else if(e&&typeof e=="object")for(const i of Object.keys(e))n.push(e[i])}return a?a.map(e=>{const i=(e==null?void 0:e.WHName)??(e==null?void 0:e.whName)??(e==null?void 0:e.warehouseName)??(e==null?void 0:e.WH_NM)??(e==null?void 0:e.wh_nm)??"",r=Number((e==null?void 0:e.AvailStock)??(e==null?void 0:e.availStock)??(e==null?void 0:e.AVAIL_STOCK)??(e==null?void 0:e.qty)??0)||0,d=(e==null?void 0:e.UnitName)??(e==null?void 0:e.unitName)??(e==null?void 0:e.UNIT_NAME)??(e==null?void 0:e.salesMgmtUnit)??"";return{whName:String(i||""),avail:r,unitName:String(d||"")}}):[]}catch{return[]}}return t.jsxs("div",{className:"card",style:{padding:12,height:"100%",overflow:"auto",background:"var(--sheet-bg)",marginTop:3},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:10},children:[t.jsx("img",{src:X,className:"icon",alt:"수주장"}),t.jsx("strong",{children:"수주장"})]}),t.jsxs("div",{className:"field inline-field",children:[t.jsx("label",{children:"수주장번호"}),t.jsx("div",{className:"subject-input",style:{padding:"6px 8px"},children:Y||v.orderNo||"-"})]}),t.jsxs("div",{className:"field inline-field",children:[t.jsx("label",{children:"회사코드"}),t.jsx("div",{className:"subject-input",style:{padding:"6px 8px"},children:(l==null?void 0:l.companyCode)||v.companyCode||"TNT"})]}),t.jsxs("div",{className:"field inline-field",children:[t.jsx("label",{children:"거래처"}),t.jsx("div",{className:"subject-input",style:{padding:"6px 8px"},children:v.customer||(l==null?void 0:l.customerName)||"-"})]}),t.jsxs("div",{className:"field inline-field",children:[t.jsx("label",{children:"등록자"}),t.jsx("div",{className:"subject-input",style:{padding:"6px 8px"},children:j||"-"})]}),t.jsxs("div",{className:"field inline-field",style:{marginBottom:8},children:[t.jsx("label",{children:"지역 그룹"}),t.jsx("input",{className:"search-input",type:"text",value:O,onChange:s=>{E(s.target.value)},placeholder:"지역 그룹"})]}),t.jsxs("div",{className:"field inline-field row-2",style:{marginTop:4},children:[t.jsx("label",{children:"요청 사항"}),t.jsx("textarea",{className:"search-input",value:T,onChange:s=>{D(s.target.value)},placeholder:"요청 사항",style:{minHeight:80}})]}),t.jsxs("div",{className:"field inline-field",children:[t.jsx("label",{children:"담당자"}),t.jsx("div",{className:"subject-input",style:{padding:"6px 8px"},children:v.manager||(l==null?void 0:l.ownerName)||"-"})]}),t.jsxs("div",{className:"field inline-field",children:[t.jsx("label",{children:"납품요청일"}),t.jsx("input",{className:"search-input",type:"date",value:I,onChange:s=>{M(s.target.value)}})]}),t.jsx("div",{style:{fontSize:12},children:t.jsxs("div",{style:{width:"100%",maxWidth:820,margin:"0 auto"},children:[t.jsx("div",{className:"table-container",style:{maxHeight:"45vh",minHeight:"36vh",marginTop:8},children:!g||g.length===0?t.jsx("div",{className:"empty-state",children:"담긴 품목이 없습니다"}):t.jsxs("table",{className:"table",style:{width:"100%"},children:[t.jsx("colgroup",{children:t.jsx("col",{})}),t.jsx("thead",{children:t.jsx("tr",{children:t.jsx("th",{children:"품목"})})}),t.jsx("tbody",{children:g.map((s,o)=>t.jsx("tr",{onDoubleClick:()=>{const n=g.filter((a,e)=>e!==o);N(n);try{localStorage.setItem("tnt.sales.ordersheet.cart",JSON.stringify(n)),window.dispatchEvent(new CustomEvent("tnt.sales.ordersheet.cart.changed",{detail:{cart:n}}))}catch{}},title:"더블클릭하면 목록에서 제외됩니다",style:{height:48},children:t.jsxs("td",{children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{fontWeight:400,flex:1},children:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[(()=>{const a=(s.companyType||s.company_type||(selectedCustomer==null?void 0:selectedCustomer.companyType)||(selectedCustomer==null?void 0:selectedCustomer.companyCode)||"").toString().toUpperCase(),e=a==="TNT"?"T":a==="DYS"?"D":a==="ALL"?"A":"",i=a==="TNT"?"#2563eb":a==="DYS"?"#10b981":a==="ALL"?"#f59e0b":"#9ca3af";return e?t.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:18,height:18,borderRadius:"50%",background:i,color:"#fff",fontSize:11,fontWeight:800,boxShadow:"0 0 0 1px rgba(0,0,0,.08)"},children:e}):null})(),t.jsx("span",{children:s.itemName}),s.itemStdUnit?t.jsxs("span",{style:{fontSize:11,color:"var(--text-muted)"},children:["(",s.itemStdUnit,")"]}):null]})}),t.jsx("input",{className:"search-input",type:"number",min:0,step:"0.01",value:s.qty===""?"":String(s.qty),placeholder:"",onChange:n=>{const a=n.target.value,e=g.slice();if(a==="")e[o]={...e[o],qty:""};else{const i=Number(a);if(!isFinite(i)||i<0)e[o]={...e[o],qty:""};else{const r=Math.floor(i*100)/100;e[o]={...e[o],qty:r}}}N(e);try{localStorage.setItem("tnt.sales.ordersheet.cart",JSON.stringify(e)),window.dispatchEvent(new CustomEvent("tnt.sales.ordersheet.cart.changed",{detail:{cart:e}}))}catch{}},style:{minWidth:120,textAlign:"right"}}),s.itemStdUnit?t.jsx("span",{style:{fontSize:12,color:"var(--text-muted)"},children:s.itemStdUnit}):null,t.jsx("span",{role:"button",tabIndex:0,className:"icon-button","aria-label":"재고 조회",title:"재고 조회",onClick:async()=>{var n;try{const a={bizUnit:"",stdDate:"",whSeq:"",itemName:String(s.itemName||""),itemNo:"",itemSeq:String(s.itemSeq||""),pageNo:"",pageSize:""},e=await fetch("/api/v1/items/avail-stock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(e.ok){const i=await e.json().catch(()=>({})),r=i&&(i.receivedPayload||i),d=JSON.stringify(r,null,2),p=P(d),u=p.reduce((y,m)=>y+(Number(m.avail)||0),0),x=((n=p.find(y=>(y.unitName||"").trim().length>0))==null?void 0:n.unitName)||"";q(y=>({...y,[String(s.itemSeq)]:{rows:p,total:u,unitName:x}}))}}catch{}},onKeyDown:n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),(async()=>{var a;try{const e={bizUnit:"",stdDate:"",whSeq:"",itemName:String(s.itemName||""),itemNo:"",itemSeq:String(s.itemSeq||""),pageNo:"",pageSize:""},i=await fetch("/api/v1/items/avail-stock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(i.ok){const r=await i.json().catch(()=>({})),d=r&&(r.receivedPayload||r),p=JSON.stringify(d,null,2),u=P(p),x=u.reduce((m,c)=>m+(Number(c.avail)||0),0),y=((a=u.find(m=>(m.unitName||"").trim().length>0))==null?void 0:a.unitName)||"";q(m=>({...m,[String(s.itemSeq)]:{rows:u,total:x,unitName:y}}))}}catch{}})())},children:t.jsx("img",{src:Q,className:"icon",alt:"재고"})}),t.jsx("span",{role:"button",tabIndex:0,className:"icon-button","aria-label":"담기 취소",title:"담기 취소",onClick:()=>{const n=g.filter((a,e)=>e!==o);N(n);try{localStorage.setItem("tnt.sales.ordersheet.cart",JSON.stringify(n)),window.dispatchEvent(new CustomEvent("tnt.sales.ordersheet.cart.changed",{detail:{cart:n}}))}catch{}},onKeyDown:n=>{if(n.key==="Enter"||n.key===" "){n.preventDefault();const a=g.filter((e,i)=>i!==o);N(a);try{localStorage.setItem("tnt.sales.ordersheet.cart",JSON.stringify(a)),window.dispatchEvent(new CustomEvent("tnt.sales.ordersheet.cart.changed",{detail:{cart:a}}))}catch{}}},children:t.jsx("img",{src:Z,className:"icon",alt:"취소"})})]}),(()=>{const n=z[String(s.itemSeq)];return!n||!n.rows.length?null:t.jsx("div",{style:{marginTop:6},children:t.jsx("div",{className:"table-container",style:{maxHeight:120,overflow:"auto",border:0},children:t.jsxs("table",{className:"table",style:{width:"100%",fontSize:11},children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"창고명"}),t.jsx("th",{style:{width:100,textAlign:"right"},children:"가용재고"}),t.jsx("th",{style:{width:120},children:"단위"})]})}),t.jsx("tbody",{children:n.rows.map((a,e)=>t.jsxs("tr",{children:[t.jsx("td",{children:a.whName||"-"}),t.jsx("td",{style:{textAlign:"right"},children:Number(a.avail||0).toLocaleString()}),t.jsx("td",{children:a.unitName||n.unitName||""})]},e))})]})})})})()]})},String(s.itemSeq)))})]})}),t.jsx("div",{className:"controls",style:{justifyContent:"flex-end",marginTop:10},children:t.jsx("button",{className:"btn btn-card btn-3d",disabled:W||!g||g.length===0||!l,onClick:async()=>{var s,o,n,a,e,i;k(!0);try{const r=String((l==null?void 0:l.companyCode)||v.companyCode||"TNT"),d=await F(r),{payload:p}=V({salesEmpSeq:d}),u={"Content-Type":"application/json"};b&&(u["X-ASSIGNEE-ID"]=String(b));const x={companyCode:r,customerSeq:(l==null?void 0:l.customerSeq)!=null?String(l.customerSeq):"",customerName:String(v.customer||(l==null?void 0:l.customerName)||""),assigneeId:b||"",regionGroup:O,requests:T,deliveryDueDate:I,createdBy:j||"",custEmpName:String(v.manager||(l==null?void 0:l.ownerName)||""),salesEmpSeq:d||void 0,items:(g||[]).map(f=>({itemSeq:String(f.itemSeq||""),itemName:f.itemName,itemSpec:f.itemSpec||"",qty:Number(f.qty)||0,itemStdUnit:f.itemStdUnit||void 0,companyType:f.companyType||void 0}))},m=await fetch(U?"/api/v1/orders?debug=true":"/api/v1/orders",{method:"POST",headers:u,body:JSON.stringify(x)}),c=await m.json().catch(()=>({}));try{$(JSON.stringify(x,null,2))}catch{}try{H(JSON.stringify(c,null,2))}catch{}if(!m.ok)throw new Error((c==null?void 0:c.error)||`HTTP ${m.status}`);if(c!=null&&c.debug){R(c.debugPayload),w({open:!0,text:"디버그 모드: ERP·Slack 전송은 중단되었습니다."});return}B(String((c==null?void 0:c.orderTextNo)||((i=(e=(a=(n=(o=(s=c==null?void 0:c.sendPayload)==null?void 0:s.ROOT)==null?void 0:o.data)==null?void 0:n.ROOT)==null?void 0:a.DataBlock1)==null?void 0:e[0])==null?void 0:i.OrderTextNo)||"")),w({open:!0,text:"주문 전송 완료"})}catch(r){w({open:!0,text:(r==null?void 0:r.message)||"주문 전송 중 오류가 발생했습니다"})}finally{k(!1)}},children:"주문"})})]})}),_.open?t.jsx("div",{role:"dialog","aria-modal":"true",className:"card",style:{position:"fixed",inset:0,background:"rgba(0,0,0,.45)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},children:t.jsxs("div",{className:"card",style:{background:"var(--panel)",padding:12,border:"1px solid var(--border)",borderRadius:10,minWidth:260,maxWidth:"86vw"},children:[t.jsx("div",{style:{marginBottom:8,fontWeight:700,textAlign:"center"},children:_.text}),t.jsx("div",{style:{display:"flex",justifyContent:"center",gap:8},children:t.jsx("button",{className:"btn btn-card btn-3d",onClick:()=>w({open:!1,text:""}),children:"확인"})})]})}):null,A?t.jsx("div",{role:"dialog","aria-modal":"true",className:"card",style:{position:"fixed",inset:0,background:"rgba(0,0,0,.65)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},children:t.jsxs("div",{className:"card",style:{background:"var(--panel)",padding:16,border:"1px solid var(--border)",borderRadius:12,minWidth:"min(90vw, 640px)",maxHeight:"80vh",overflow:"auto"},children:[t.jsx("div",{style:{marginBottom:12,fontWeight:700},children:"디버그: 전송 직전 payload"}),t.jsx("div",{style:{fontSize:12,marginBottom:16,whiteSpace:"pre-wrap",fontFamily:"monospace",maxHeight:"55vh",overflow:"auto",border:"1px dashed var(--border)",padding:8,background:"var(--panel-2)"},children:JSON.stringify(A,null,2)}),t.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:t.jsx("button",{className:"btn btn-card btn-3d",onClick:()=>R(null),children:"닫기"})})]})}):null]})}export{le as OrderSheetRightPanel};
